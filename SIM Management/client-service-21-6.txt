package com.uninor.service;

import com.itextpdf.io.image.ImageData;
import com.itextpdf.io.image.ImageDataFactory;
import com.itextpdf.kernel.colors.DeviceRgb;
import com.itextpdf.kernel.font.PdfFont;
import com.itextpdf.kernel.font.PdfFontFactory;
import com.itextpdf.kernel.geom.PageSize;
import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.kernel.pdf.canvas.PdfCanvas;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.*;
import com.itextpdf.layout.properties.TextAlignment;
import com.itextpdf.layout.properties.UnitValue;
import com.itextpdf.text.DocumentException;
import com.uninor.dto.*;
import com.uninor.enumeration.OrderStatusEnum;
import com.uninor.enumeration.PaymentStatusEnum;
import com.uninor.exceptions.DataNotFoundException;
import com.uninor.exceptions.InvalidDataFoundException;
import com.uninor.exceptions.SimNotAvailableException;
import com.uninor.helper.Helper;
import com.uninor.helper.InvoiceNumberGenerator;
import com.uninor.model.*;
import com.uninor.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
//import com.itextpdf.text.pdf.PdfPTable;
//import org.springframework.web.bind.MethodArgumentNotValidException;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.transaction.Transactional;
import java.beans.Transient;
import java.io.File;
import java.io.IOException;
import java.util.*;
import java.util.List;

@Service
public class ClientService {

    @Autowired
    private PlanRepository planRepository;

    @Autowired
    private CategoryRepository categoryRepository;

    @Autowired
    private ClientRepository clientRepository;

    @Autowired
    private CuponRepository cuponRepository;

    @Autowired
    private SimCardRepository simCardRepository;

    @Autowired
    private PlanActivationRepository planActivationRepository;

    @Autowired
    private RoamingActivationRepository roamingActivationRepository;

    @Autowired
    private InvoiceTableRepository invoiceTableRepository;

    private ShowPlanDto createPopularPlanDto(List<Plan> planList, String planCategory){
        ShowPlanDto popularPlans = new ShowPlanDto();
        List<PlanDetailsDto> displayList = new ArrayList<>();
        popularPlans.setPlanCategory(planCategory);
        popularPlans.setPlanCount(planList.size());
        for(Plan plan : planList){
            PlanDetailsDto planDetails = new PlanDetailsDto();
            planDetails.setPlanId(plan.getPlanId());
            planDetails.setPlanAmount(plan.getRechargeAmount());
            planDetails.setPlanValidity(plan.getValidity());
            planDetails.setSmsAllowance(plan.getSmsAllowance());
            planDetails.setDataAmount((plan.getDataAllowance() / 1000));
            planDetails.setAdditionalData((plan.getExtraData() / 1000));
            planDetails.setDailyRefreshing(plan.getIsRefreshing());

            Double totalData;
            if(plan.getIsRefreshing()){
                totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
            }else {
                totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
            }

            planDetails.setTotalData(totalData);
            displayList.add(planDetails);
        }
        popularPlans.setPlanList(displayList);
        return popularPlans;
    }

    private ShowPlanDto createAnnualPlanDto(List<Plan> planList, String planCategory){
        ShowPlanDto annualPlan = new ShowPlanDto();
        List<PlanDetailsDto> displayList = new ArrayList<>();
        annualPlan.setPlanCategory(planCategory);
        int count = 0;
        for(Plan plan : planList){
            if(plan.getValidity() > 300){
                count++;
                PlanDetailsDto planDetails = new PlanDetailsDto();
                planDetails.setPlanId(plan.getPlanId());
                planDetails.setPlanAmount(plan.getRechargeAmount());
                planDetails.setPlanValidity(plan.getValidity());
                planDetails.setSmsAllowance(plan.getSmsAllowance());
                planDetails.setDataAmount((plan.getDataAllowance() / 1000));
                planDetails.setAdditionalData((plan.getExtraData() / 1000));
                planDetails.setDailyRefreshing(plan.getIsRefreshing());

                Double totalData;
                if(plan.getIsRefreshing()){
                    totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
                }else {
                    totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
                }

                planDetails.setTotalData(totalData);
                displayList.add(planDetails);
            }
        }
        annualPlan.setPlanCount(count);
        annualPlan.setPlanList(displayList);
        return annualPlan;
    }

    public ResponseEntity<Map<String, ShowPlanDto>> getRechargeDetails(RechargePlanFilter rechargePlanFilter){
//    public String getRechargeDetails(RechargePlanFilter rechargePlanFilter){
        Map<String,ShowPlanDto> responseMap = new LinkedHashMap<>();
        List<PlanCategories> planCategories = this.categoryRepository.getAllAvailableCategory();
        List<Plan> availablePlans;
        List<Plan> popularPlans = this.planRepository.getPopularActivePlans();
        if(rechargePlanFilter.isIsfilterApplied()){
            availablePlans = this.planRepository.getActiveFilteredPlan(rechargePlanFilter);
        }else {
            availablePlans = this.planRepository.getActivePlan();
        }

        ShowPlanDto popularPlan = createPopularPlanDto(popularPlans,"Popular Plans");
        responseMap.put("Popular Plans", popularPlan);

        ShowPlanDto annualPlan = createAnnualPlanDto(availablePlans,"Annual Plans");
        responseMap.put("Annual Plans", annualPlan);

        for(PlanCategories planCategory : planCategories){
            ShowPlanDto displayPlan = new ShowPlanDto();
            List<PlanDetailsDto> displayList = new ArrayList<>();
            displayPlan.setPlanCategory(planCategory.getPlanCategory());
            int planCount = 0;
           for(Plan plan : availablePlans){
               if(planCategory.getPlanId() == plan.getCategoryId().getPlanId()){
                   planCount++;
                   PlanDetailsDto planDetails = new PlanDetailsDto();
                   planDetails.setPlanId(plan.getPlanId());
                   planDetails.setPlanAmount(plan.getRechargeAmount());
                   planDetails.setPlanValidity(plan.getValidity());
                   planDetails.setSmsAllowance(plan.getSmsAllowance());
                   planDetails.setDataAmount((plan.getDataAllowance() / 1000));
                   planDetails.setAdditionalData((plan.getExtraData() / 1000));
                   planDetails.setDailyRefreshing(plan.getIsRefreshing());

                   Double totalData;
                   if(plan.getIsRefreshing()){
                       totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
                   }else {
                       totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
                   }

                   planDetails.setTotalData(totalData);
                   displayList.add(planDetails);

               }

           }
            displayPlan.setPlanCount(planCount);
            displayPlan.setPlanList(displayList);
            responseMap.put(planCategory.getPlanCategory(), displayPlan);
        }


        return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);


    }

    public ResponseEntity<Map<String,PlanDetailsDto>> getPlanDetails(int planId){
        if(planId == 0){
            throw new DataNotFoundException("No such plan found!");
        }
        Map<String,PlanDetailsDto> responseMap = new HashMap<>();
        Plan plan = this.planRepository.getPlanById(planId);
        try {
            PlanDetailsDto planDetails = new PlanDetailsDto();
            planDetails.setPlanId(plan.getPlanId());
            planDetails.setPlanAmount(plan.getRechargeAmount());
            planDetails.setPlanValidity(plan.getValidity());
            planDetails.setSmsAllowance(plan.getSmsAllowance());
            planDetails.setDataAmount((plan.getDataAllowance() / 1000));
            planDetails.setAdditionalData((plan.getExtraData() / 1000));
            planDetails.setDailyRefreshing(plan.getIsRefreshing());
            planDetails.setVoiceAllowance(plan.getVoiceAllowance());
            Double totalData;
            if(plan.getIsRefreshing()){
                totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
            }else {
                totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
            }

            planDetails.setTotalData(totalData);
            responseMap.put("Plan", planDetails);
            return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);
        }catch (NullPointerException e){
            throw new DataNotFoundException("No Plan Found! Please try again");
        }
    }

    public  ResponseEntity<Map<String, UserPlanDetailsDto>> getUserPlanDetails(int planId, HttpServletRequest httpServletRequest){
        String clientEmail = (String) httpServletRequest.getSession().getAttribute("clientEmail");
        Client client = this.clientRepository.getUserByEmail(clientEmail).get(0);
        if(planId == 0){
            throw new DataNotFoundException("No such plan found!");
        }
        Map<String,UserPlanDetailsDto> responseMap = new HashMap<>();
        Plan plan = this.planRepository.getPlanById(planId);
        try {
            UserPlanDetailsDto planDetails = new UserPlanDetailsDto();
            planDetails.setPlanId(plan.getPlanId());
            planDetails.setPlanAmount(plan.getRechargeAmount());
            planDetails.setPlanValidity(plan.getValidity());
            planDetails.setSmsAllowance(plan.getSmsAllowance());
            planDetails.setDataAmount((plan.getDataAllowance() / 1000));
            planDetails.setAdditionalData((plan.getExtraData() / 1000));
            planDetails.setDailyRefreshing(plan.getIsRefreshing());
            planDetails.setVoiceAllowance(plan.getVoiceAllowance());
            Double totalData;
            if(plan.getIsRefreshing()){
                totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
            }else {
                totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
            }

            planDetails.setTotalData(totalData);
            planDetails.setWalletAmount(client.getWalletAmount());

            Double taxAmount = plan.getRechargeAmount() * 0.18;
            taxAmount = Double.valueOf(String.format("%.2f", taxAmount));

            Double planPrice = plan.getRechargeAmount() - taxAmount;
            planPrice = Double.valueOf(String.format("%.2f", planPrice));

            planDetails.setTaxAmount(taxAmount);
            planDetails.setPlanPriceWithoutTax(planPrice);
            responseMap.put("Plan", planDetails);
            return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);
        }catch (NullPointerException e){
            throw new DataNotFoundException("No Plan Found! Please try again");
        }
    }

    public ResponseEntity<Map<String,String>> validateWalletAmount(ClientWalletDto walletDto){
        Map<String,String> responseMap = new HashMap<>();
        Client client = this.clientRepository.getClientById(Integer.parseInt(walletDto.getClientId()));
        if(client == null){
            throw new DataNotFoundException("No such client found!");
        }

        if(client.getWalletAmount() >= Double.parseDouble(walletDto.getAmount())){
            responseMap.put("messages","Sufficient Amount available");
            return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);
        }else {
            responseMap.put("errors","Insufficient Balance");
            return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.FORBIDDEN);
        }
    }

    private CuponDto getCuponDto(Cupon cupon){
        CuponDto cuponDto = new CuponDto();
        cuponDto.setCuponId(cupon.getCuponId());
        cuponDto.setCuponName(cupon.getCuponName());
        cuponDto.setRewardAmount(cupon.getRewardAmount());
        cuponDto.setMaxRewardAmount(cupon.getMaxRewardAmount());
        return cuponDto;
    }

    public ResponseEntity<Map<String, CuponDto>> validateCuponCode(ClientCuponDto clientCuponDto){
        Map<String,CuponDto> responseMap = new HashMap<>();
        List<ClientCupons> cuponList = this.cuponRepository.getClientCuponByCuponCode(Integer.parseInt(clientCuponDto.getClientId()),clientCuponDto.getCuponCode());
        if(cuponList.isEmpty()){
            throw new DataNotFoundException("Invalid Cupon Code");
        }else {
            ClientCupons clientCupons = cuponList.get(0);
            if(clientCupons.isExpired() == true){
                throw new DataNotFoundException("Cupon Code Expired.");
            }
            if(clientCupons.isUsed() == true){
                throw new DataNotFoundException("Cupon Code already used.");
            }

            CuponDto cuponDto = getCuponDto(clientCupons.getCupon());
            responseMap.put("cuponDetails",cuponDto);
            return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);
        }

    }

    public ResponseEntity<Map<String,String>> rechargePayment(CuponWalletDto cuponWalletDto, HttpServletRequest httpServletRequest){
        HttpSession session = httpServletRequest.getSession();
        String mobileNUmber = (String) session.getAttribute("loggedInMobile");
        SimCard simCard;
        Double taxableAmount = 0.0;
        Double taxApplied = 0.0;
        try {
            simCard = this.simCardRepository.getSimCardDetailsByNumber(mobileNUmber).get(0);
        }catch (NullPointerException e){
            throw new SimNotAvailableException("Error while getting mobile number details");
        }

        Map<String,String> responseMap = new HashMap<>();
        boolean cuponError = false;
        boolean walletError = false;
        if(cuponWalletDto.getEnteredWalletAmount().isEmpty()){
            cuponWalletDto.setEnteredWalletAmount("0");
        }

        Cupon validCupon;
        boolean isWalletAmountEmpty = false;
        boolean isCuponEmpty = false;
        Client client = this.clientRepository.getClientById(Integer.parseInt(cuponWalletDto.getClientId()));
        if(client == null){
            throw new DataNotFoundException("No such client found!");
        }

        Plan plan = this.planRepository.getPlanById(Integer.parseInt(cuponWalletDto.getPlanId()));
        if(plan == null){
            throw new DataNotFoundException("No such Plan found!");
        }

        List<ClientCupons> cuponList = this.cuponRepository.getClientCuponByCuponCode(client.getClientId(),cuponWalletDto.getCuponCode());

        if(cuponWalletDto.getCuponCode().isEmpty() || cuponWalletDto.getCuponCode() == ""){
            isCuponEmpty = true;
        }

        if(cuponList.isEmpty()){
            cuponError = true;
        }else {
            ClientCupons clientCupons = cuponList.get(0);
            if(clientCupons.isExpired()){
                cuponError = true;
            }
            if(clientCupons.isUsed()){
                cuponError = true;
            }

            if(!clientCupons.isExpired() && !clientCupons.isUsed()) {
                cuponError = false;
            }
        }

        if(!cuponWalletDto.getEnteredWalletAmount().isEmpty()) {
            if(!(client.getWalletAmount() >= Double.parseDouble(cuponWalletDto.getEnteredWalletAmount()))){
                walletError = true;
            }
        }else {
            walletError = true;
            isWalletAmountEmpty = true;
        }

        //Main Calculations

        Double planAmountWithTax = plan.getRechargeAmount();
        Double taxAmount = (Helper.CGST + Helper.SGST)/ 100;

        Double planTax = planAmountWithTax * taxAmount;
        planTax = Double.valueOf(String.format("%.2f", planTax));

        Double planPriceWithoutTax = planAmountWithTax - planTax;
        Double discountAmount = 0.00;
        Double priceWithoutWallet = planPriceWithoutTax;
        Double payableAmount = planPriceWithoutTax;

        if(!cuponError){
            ClientCupons updateClientCupon = cuponList.get(0);
            Cupon cupon = updateClientCupon.getCupon();
            if(cupon.isDeductable()){
                double discountPercent = Double.parseDouble(cupon.getRewardAmount().split("%")[0]) / 100;
                discountAmount = planPriceWithoutTax * discountPercent <= cupon.getMaxRewardAmount() + 0.99 ? planPriceWithoutTax * discountPercent : cupon.getMaxRewardAmount();
                discountAmount = Double.valueOf(String.format("%.2f", discountAmount));
                priceWithoutWallet = priceWithoutWallet - discountAmount;
            }

            if(!cupon.isCashback() && !cupon.isDeductable()){
                cuponError = true;
            }
        }

        taxableAmount = priceWithoutWallet;
        planTax = priceWithoutWallet * taxAmount;
        planTax = Double.valueOf(String.format("%.2f", planTax));
        taxAmount = planTax;
        priceWithoutWallet += planTax;
        priceWithoutWallet = Double.valueOf(String.format("%.2f", priceWithoutWallet));
        payableAmount = priceWithoutWallet;
        double minWalletAmount = 0;
        if(priceWithoutWallet < Double.parseDouble(cuponWalletDto.getEnteredWalletAmount())+10.0){
            minWalletAmount =  priceWithoutWallet <= client.getWalletAmount() ? priceWithoutWallet : client.getWalletAmount();
            cuponWalletDto.setEnteredWalletAmount(String.valueOf(minWalletAmount));

        }
//        updateBuyPlanDetailsDto.setUsedWalletAmount(Double.parseDouble(cuponWalletDto.getEnteredWalletAmount()));
        if(walletError){
            payableAmount = payableAmount - Double.parseDouble(cuponWalletDto.getEnteredWalletAmount());
            payableAmount = Double.valueOf(String.format("%.2f", payableAmount));
            if(payableAmount == 0){
                payableAmount += 10.00;
                minWalletAmount = Double.parseDouble(cuponWalletDto.getEnteredWalletAmount()) - 10.00;
            }

            client.setWalletAmount(minWalletAmount);
        }

        if(isWalletAmountEmpty){
            walletError = false;
        }

        if (isCuponEmpty){
            cuponError = false;
        }

        if(cuponError || walletError){
            throw new InvalidDataFoundException("Please check cupon code and wallet amount!");
        }else {

            if(plan.getCategoryId().isRoamingAvailable() && isPlanValid(plan,simCard,client)){
                RoamingActivation roamingActivation = saveRoamingActivationPlan(plan,simCard);
                OrderTable orderTable = saveOrderDetails(client,plan,simCard,payableAmount,discountAmount);
                InvoiceTable invoiceTable = saveInvoiceTableDetails(client,orderTable,mobileNUmber,discountAmount,taxAmount,payableAmount,taxableAmount);
                this.roamingActivationRepository.saveRoamingActivationDetails(roamingActivation);
                this.invoiceTableRepository.saveInvoiceTableDetails(invoiceTable);
            }

            if(isPlanValid(plan,simCard,client) && !plan.getCategoryId().isRoamingAvailable()){
                PlanUsage planUsage = initiatePlanUsageDetails(plan);
                PlanActivation planActivation = savePlanActivationDetails(simCard,plan,planUsage);
                OrderTable orderTable = saveOrderDetails(client,plan,simCard,payableAmount,discountAmount);
                InvoiceTable invoiceTable = saveInvoiceTableDetails(client,orderTable,mobileNUmber,discountAmount,taxAmount,payableAmount,taxableAmount);
                this.invoiceTableRepository.saveInvoiceTableDetails(invoiceTable);
                this.planActivationRepository.savePlanActivation(planActivation);
            }

            if(!cuponError){
                ClientCupons updateClientCupon = cuponList.get(0);
                Cupon cupon = updateClientCupon.getCupon();
                if(cupon.isDeductable()){
                    updateClientCupon.setExpired(true);
                    updateClientCupon.setUsed(true);
                    this.cuponRepository.updateClientCupons(updateClientCupon);
                }

            }

            this.clientRepository.updateClient(client);


        }
        responseMap.put("messages","Recharge bought successfully!");
        return new ResponseEntity<>(responseMap, new HttpHeaders(), HttpStatus.OK);

    }

    public InvoiceTable saveInvoiceTableDetails(Client client, OrderTable orderTable, String mobileNumber, Double discountAmount, Double taxAmount, Double totalAmount, Double taxableAmount){

        InvoiceNumberGenerator generator = InvoiceNumberGenerator.getInstance();

        InvoiceTable invoiceTable = new InvoiceTable();
        invoiceTable.setClient(client);
        invoiceTable.setInvoiceNumber(generator.generateInvoiceNumber());
        invoiceTable.setOrderTable(orderTable);
        invoiceTable.setTaxAmount(taxAmount);
        invoiceTable.setTotalAmount(totalAmount);
        invoiceTable.setBillingAddress(client.getStreet() + " ," + client.getCity() + " ," + client.getState() + " ," + client.getZipcode() + ".");
        invoiceTable.setDiscountAmount(discountAmount);
        invoiceTable.setMobileNumber(mobileNumber);
        invoiceTable.setPaymentStatus(PaymentStatusEnum.PAID.getPaymentStatusId());
        invoiceTable.setTaxableAmount(taxableAmount);
        return invoiceTable;

    }

    public OrderTable saveOrderDetails(Client client, Plan plan, SimCard simCard, Double totalAmount, Double totalDiscount) {
        OrderTable orderTable = new OrderTable();
        orderTable.setClient(client);
        orderTable.setOrderRef(Helper.orderIdGenerator());
        orderTable.setOrderStatus(OrderStatusEnum.COMPLETED.getOrderStatusId());
        orderTable.setPlan(plan);
        orderTable.setSimCard(simCard);
        orderTable.setPaymentMethod("UPI");
        orderTable.setPaymentRefrence(Helper.paymentRefGenerator());
        orderTable.setTotalAmount(totalAmount);
        orderTable.setTotalDiscount(totalDiscount);
        return orderTable;
    }

    public RoamingActivation saveRoamingActivationPlan(Plan plan, SimCard simCard){
        RoamingActivation roamingActivation = new RoamingActivation();
        roamingActivation.setActivationDate(null);
        roamingActivation.setRoamingPlan(plan);
        roamingActivation.setActive(false);
        roamingActivation.setExpired(false);
        roamingActivation.setRoamingDataUsage(plan.getDataAllowance());
        roamingActivation.setSimCard(simCard);
        roamingActivation.setSmsUsage(plan.getSmsAllowance());
        int voiceAllowance = Integer.parseInt(plan.getVoiceAllowance().split(" ")[0])*60;
        roamingActivation.setVoiceUsage(voiceAllowance);
        roamingActivation.setExpirationDate(null);
        return roamingActivation;
    }

    public boolean isPlanValid(Plan plan, SimCard simCard, Client client) {
        int planType = plan.getCategoryId().getPlanType();
        boolean isAddOn = plan.getCategoryId().isAddOn();

        if(simCard.getSimType() != planType){
            String message = planType == 1?"Prepaid":"Postpaid";
            throw new InvalidDataFoundException("This Plan is not for " + message + " Sim");
        }

        if(isAddOn){
            List<PlanActivation> listPlanActivation = this.planActivationRepository.getActiveSimPlan(simCard);
            if(listPlanActivation.isEmpty()){
                throw new InvalidDataFoundException("You need a active base plan to buy add on packs");
            }
        }

        return true;
    }

    public PlanUsage initiatePlanUsageDetails(Plan plan) {
        PlanUsage planUsage = new PlanUsage();

        if(plan.getCategoryId().getPlanType() == 1){
            planUsage.setDataUsage(plan.getDataAllowance());
            planUsage.setSmsUsage(plan.getSmsAllowance());
        }else {
            planUsage.setDataUsage(0.00);
            planUsage.setSmsUsage(0);
        }

        if(plan.getIsExtraDataAvailable()){
            planUsage.setAdditionalData(plan.getExtraData());
        }else {
            planUsage.setAdditionalData(0.00);
        }
        return planUsage;
    }

    public PlanActivation savePlanActivationDetails(SimCard simCard,Plan plan, PlanUsage planUsage){
        PlanActivation planActivation = new PlanActivation();
        planActivation.setSimCard(simCard);
        planActivation.setPlan(plan);
        planActivation.setPlanUsage(planUsage);
        planActivation.setActivationDate(null);
        planActivation.setExpirationDate(null);
        planActivation.setActive(false);
        planActivation.setExpired(false);
        return planActivation;
    }

    public ResponseEntity<Map<String , UpdateBuyPlanDetailsDto>> validateCuponWalletDetails(CuponWalletDto cuponWalletDto){

        Map<String,UpdateBuyPlanDetailsDto> responseMap = new HashMap<>();
        if(cuponWalletDto.getEnteredWalletAmount().isEmpty()){
            cuponWalletDto.setEnteredWalletAmount("0");
        }
        UpdateBuyPlanDetailsDto updateBuyPlanDetailsDto = new UpdateBuyPlanDetailsDto();
        Cupon validCupon;
        boolean isWalletAmountEmpty = false;
        boolean isCuponEmpty = false;
        Client client = this.clientRepository.getClientById(Integer.parseInt(cuponWalletDto.getClientId()));
        if(client == null){
            throw new DataNotFoundException("No such client found!");
        }

        Plan plan = this.planRepository.getPlanById(Integer.parseInt(cuponWalletDto.getPlanId()));
        if(plan == null){
            throw new DataNotFoundException("No such Plan found!");
        }

        updateBuyPlanDetailsDto.setPlanId(plan.getPlanId());
        updateBuyPlanDetailsDto.setPlanAmount(plan.getRechargeAmount());
        updateBuyPlanDetailsDto.setPlanValidity(plan.getValidity());
        updateBuyPlanDetailsDto.setSmsAllowance(plan.getSmsAllowance());
        updateBuyPlanDetailsDto.setDataAmount((plan.getDataAllowance() / 1000));
        updateBuyPlanDetailsDto.setAdditionalData((plan.getExtraData() / 1000));
        updateBuyPlanDetailsDto.setDailyRefreshing(plan.getIsRefreshing());
        updateBuyPlanDetailsDto.setVoiceAllowance(plan.getVoiceAllowance());
        Double totalData;
        if(plan.getIsRefreshing()){
            totalData = (plan.getDataAllowance() / 1000) * plan.getValidity() + plan.getExtraData();
        }else {
            totalData = (plan.getDataAllowance() / 1000) + plan.getExtraData();
        }

        updateBuyPlanDetailsDto.setTotalData(totalData);
        updateBuyPlanDetailsDto.setWalletAmount(client.getWalletAmount());


        List<ClientCupons> cuponList = this.cuponRepository.getClientCuponByCuponCode(client.getClientId(),cuponWalletDto.getCuponCode());

        if(cuponWalletDto.getCuponCode().isEmpty() || cuponWalletDto.getCuponCode() == ""){
            isCuponEmpty = true;
            updateBuyPlanDetailsDto.setCuponApplied(false);
        }

        if(cuponList.isEmpty()){
            updateBuyPlanDetailsDto.setCuponErrorMessage("Invalid Cupon Code!");
            updateBuyPlanDetailsDto.setCuponError(true);
        }else {
            ClientCupons clientCupons = cuponList.get(0);
            if(clientCupons.isExpired()){
                updateBuyPlanDetailsDto.setCuponErrorMessage("Cupon code Expired!");
                updateBuyPlanDetailsDto.setCuponError(true);
                updateBuyPlanDetailsDto.setCuponApplied(false);
            }
            if(clientCupons.isUsed()){
                updateBuyPlanDetailsDto.setCuponErrorMessage("Cupon code already used");
                updateBuyPlanDetailsDto.setCuponError(true);
                updateBuyPlanDetailsDto.setCuponApplied(false);
            }


            if(!clientCupons.isExpired() && !clientCupons.isUsed()) {
                validCupon = clientCupons.getCupon();
                updateBuyPlanDetailsDto.setCuponError(false);
                updateBuyPlanDetailsDto.setCuponId(validCupon.getCuponId());
                updateBuyPlanDetailsDto.setCuponName(validCupon.getCuponName());
                updateBuyPlanDetailsDto.setRewardAmount(validCupon.getRewardAmount());
                updateBuyPlanDetailsDto.setMaxRewardAmount(validCupon.getMaxRewardAmount());
            }
        }

        if(!cuponWalletDto.getEnteredWalletAmount().isEmpty() && cuponWalletDto.getEnteredWalletAmount()!= "") {
            if(client.getWalletAmount() >= Double.parseDouble(cuponWalletDto.getEnteredWalletAmount())){
                updateBuyPlanDetailsDto.setWalletError(false);
            }else {
                updateBuyPlanDetailsDto.setWalletError(true);
                updateBuyPlanDetailsDto.setWalletErrorMessage("Insufficient Wallet Balance");
            }
        }else {
            updateBuyPlanDetailsDto.setWalletError(true);
            isWalletAmountEmpty = true;
        }


        //Main Calculations

        Double planAmountWithTax = plan.getRechargeAmount();
        Double taxAmount = (Helper.CGST + Helper.SGST)/ 100;

        Double planTax = planAmountWithTax * taxAmount;
        planTax = Double.valueOf(String.format("%.2f", planTax));

        Double planPriceWithoutTax = planAmountWithTax - planTax;
        Double discountAmount = 0.00;
        Double priceWithoutWallet = planPriceWithoutTax;
        Double payableAmount = planPriceWithoutTax;

        if(!updateBuyPlanDetailsDto.isCuponError()){
            Cupon cupon = cuponList.get(0).getCupon();
            if(cupon.isDeductable()){
                double discountPercent = Double.parseDouble(cupon.getRewardAmount().split("%")[0]) / 100;
                discountAmount = planPriceWithoutTax * discountPercent <= cupon.getMaxRewardAmount() + 0.99 ? planPriceWithoutTax * discountPercent : cupon.getMaxRewardAmount();
                discountAmount = Double.valueOf(String.format("%.2f", discountAmount));
                priceWithoutWallet = priceWithoutWallet - discountAmount;
                updateBuyPlanDetailsDto.setCuponApplied(true);
            }

            if(!cupon.isCashback() && !cupon.isDeductable()){
                updateBuyPlanDetailsDto.setCuponError(true);
                updateBuyPlanDetailsDto.setCuponErrorMessage("Coupon invalid here. Redeem from rewards.");
                updateBuyPlanDetailsDto.setCuponApplied(false);
            }
        }
        planTax = priceWithoutWallet * taxAmount;
        planTax = Double.valueOf(String.format("%.2f", planTax));
        priceWithoutWallet += planTax;
        priceWithoutWallet = Double.valueOf(String.format("%.2f", priceWithoutWallet));
        payableAmount = priceWithoutWallet;

        if(priceWithoutWallet < Double.parseDouble(cuponWalletDto.getEnteredWalletAmount())+10.0){
            double minWalletAmount =  priceWithoutWallet <= client.getWalletAmount() ? priceWithoutWallet : client.getWalletAmount();
            cuponWalletDto.setEnteredWalletAmount(String.valueOf(minWalletAmount));
        }
        updateBuyPlanDetailsDto.setUsedWalletAmount(Double.parseDouble(cuponWalletDto.getEnteredWalletAmount()));
        if(!updateBuyPlanDetailsDto.isWalletError()){
            payableAmount = payableAmount - Double.parseDouble(cuponWalletDto.getEnteredWalletAmount());
            payableAmount = Double.valueOf(String.format("%.2f", payableAmount));
            if(payableAmount == 0){
                payableAmount += 10.00;
                double wAMount = Double.parseDouble(cuponWalletDto.getEnteredWalletAmount()) - 10.00;
                updateBuyPlanDetailsDto.setUsedWalletAmount(Double.valueOf(String.format("%.2f", wAMount)));
            }


        }

        if(isWalletAmountEmpty){
            updateBuyPlanDetailsDto.setWalletError(false);
        }

        if (isCuponEmpty){
            updateBuyPlanDetailsDto.setCuponError(false);
        }

        updateBuyPlanDetailsDto.setDiscountApplied(discountAmount);
        updateBuyPlanDetailsDto.setFinalPayableAmount(payableAmount);
        updateBuyPlanDetailsDto.setPlanAmount(plan.getRechargeAmount());
        updateBuyPlanDetailsDto.setPlanPriceWithoutWallet(priceWithoutWallet);
        updateBuyPlanDetailsDto.setPlanPriceWithoutTax(planPriceWithoutTax);
        updateBuyPlanDetailsDto.setTaxAmount(planTax);


        responseMap.put("updatedDetails",updateBuyPlanDetailsDto);
        return new ResponseEntity<>(responseMap,new HttpHeaders(), HttpStatus.OK);
    }

    public void generatePdf(HttpServletRequest httpServletRequest) throws IOException, DocumentException {

        String path = System.getenv("UninorUploadPath");
        String fullPath = path + "11/" + "invoicee" + "." + "pdf";


        HttpSession httpSession = httpServletRequest.getSession();
//		        String dest = "invoice.pdf";
        String p = httpSession.getServletContext().getRealPath("/") + "WEB-INF" + File.separator + "resources"
                + File.separator + "viewDocs" + File.separator + "Encounter" + File.separator + "mkcaKavit" + ".pdf";
        PdfWriter writer = new PdfWriter(fullPath);
        PdfDocument pdf = new PdfDocument(writer);
        pdf.addNewPage();
        Document document = new Document(pdf, PageSize.A4);

        PdfFont font = PdfFontFactory.createFont(com.itextpdf.io.font.constants.StandardFonts.HELVETICA);
        PdfFont bold = PdfFontFactory.createFont(com.itextpdf.io.font.constants.StandardFonts.HELVETICA_BOLD);
        float width = pdf.getDefaultPageSize().getWidth();
        float height = pdf.getDefaultPageSize().getHeight();
        PdfCanvas canvas = new PdfCanvas(pdf.getFirstPage());
        canvas.rectangle(20, 20, width - 40, height - 40);
        canvas.stroke();

//        ImageData imageData = ImageDataFactory.create(
//                httpSession.getServletContext().getRealPath("/") + "WEB-INF" + File.separator + "resources"	+ File.separator + "images" + File.separator + "uninor_logo_big_resize.jpg");
//        System.out.println(httpSession.getServletContext().getRealPath("/") + "WEB-INF" + File.separator + "resources"	+ File.separator + "images/uninor-remove-bg.png");
//        Image image = new Image(imageData);
//        image.setFixedPosition(pdf.getDefaultPageSize().getWidth() / 2 - (image.getImageScaledWidth() / 2),
//                pdf.getDefaultPageSize().getHeight() / 2 - (image.getImageScaledHeight() / 2));
//        image.setOpacity(0.3f);
//        document.add(image);
        document.add(new Paragraph("Uninor Retail Limited")
                .setFont(bold)
                .setTextAlignment(TextAlignment.CENTER)
                .setFontSize(18));

        // Adding title
        document.add(new Paragraph("Tax Invoice")
                .setFont(bold)
                .setTextAlignment(TextAlignment.CENTER)
                .setFontSize(16));

        document.add(new Paragraph("(Original for Recipient)")
                .setFont(font)
                .setTextAlignment(TextAlignment.CENTER)
                .setFontSize(12));



        // Adding company details
        document.add(new Paragraph(
                "")
                .setFont(font)
                .setFontSize(10)
                .setMarginTop(25));

        // Adding invoice details table
        float[] columnWidths = {1.5f, 3.5f};
        Table table = new Table(UnitValue.createPercentArray(columnWidths)).useAllAvailableWidth();
        table.addCell(new Cell().add(new Paragraph("Customer Name:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Shah Aashiv Rajan")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Uninor Number.:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("6351627219")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Invoice No:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("24R25I0021629799")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Order Ref. No.:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("BR000AXU08TE")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("GST No:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("AABCR1718E 24AABCR1718E1ZV")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("PAN No:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("AABCR1718E")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Payment Ref. No.:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("20240616210350000009210092")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Mode of Payment:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("UPI")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Payment Date & Time:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("16 Jun,2024 21:20:46")).setFont(font).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("Billing Address:")).setFontSize(11).setPaddingLeft(14));
        table.addCell(new Cell().add(new Paragraph("13, Kusumkunj\n" +
                                                        "Mahavir Jain\n" +
                                                        "Society,Opp Jain Derasar Godhra \n" +
                                                         "Gujarat 389001\n")).setFont(font).setFontSize(11).setPaddingLeft(14));
        document.add(table);

        // Adding customer details
        document.add(new Paragraph(" ")
                .setFont(font)
                .setFontSize(10)
                .setMarginTop(20));

        // Add table
        float[] itemColumnWidths = {1, 5, 3, 3, 3, 3};
        Table itemTable = new Table(UnitValue.createPercentArray(itemColumnWidths));
        itemTable.addHeaderCell("Sr. No.").setFont(bold).setTextAlignment(TextAlignment.CENTER);
        itemTable.addHeaderCell("Plan Details");
        itemTable.addHeaderCell("SAC");
        itemTable.addHeaderCell("MRP");
        itemTable.addHeaderCell("Discount");
        itemTable.addHeaderCell("Taxable Amount");
        document.add(itemTable);

        float[] itemColumnRowWidths = {1, 5, 3, 3, 3, 3};
        Table itemRowTable = new Table(UnitValue.createPercentArray(itemColumnRowWidths)).useAllAvailableWidth();
        // Add table row data
        itemRowTable.addCell("1").setTextAlignment(TextAlignment.CENTER);
        itemRowTable.addCell("MRP 19 998422");
        itemRowTable.addCell("5589");
        itemRowTable.addCell("19.00");
        itemRowTable.addCell("0.00");
        itemRowTable.addCell("16.10");
        document.add(itemRowTable);

        float[] taxColumnWidths = {5,1};
        Table taxTable = new Table(UnitValue.createPercentArray(taxColumnWidths)).useAllAvailableWidth();
        taxTable.addCell(new Cell().add(new Paragraph("Total Taxable Amount")).setFont(bold).setPaddingRight(5).setTextAlignment(TextAlignment.RIGHT).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("25.00")).setFont(font).setPaddingLeft(5).setTextAlignment(TextAlignment.CENTER).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("CGST (9%)")).setFont(bold).setPaddingRight(5).setTextAlignment(TextAlignment.RIGHT).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("25.00")).setFont(font).setPaddingLeft(5).setTextAlignment(TextAlignment.CENTER).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("SGST (%)")).setFont(bold).setPaddingRight(5).setTextAlignment(TextAlignment.RIGHT).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("25.00")).setFont(font).setPaddingLeft(5).setTextAlignment(TextAlignment.CENTER).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("Total Paid Amount")).setFont(bold).setPaddingRight(5).setTextAlignment(TextAlignment.RIGHT).setFontSize(12));
        taxTable.addCell(new Cell().add(new Paragraph("25.00")).setFont(font).setPaddingLeft(5).setTextAlignment(TextAlignment.CENTER).setFontSize(12));
        document.add(taxTable);


        // Adding footer
        document.add(new Paragraph("\nTelecommunication services to be provided by Uninor Infocomm Limited\n" +
                "All disputes are subjected to Gujarat Jurisdiction\n" +
                "Tax is not payable under Reverse Charge basis for this supply.\n")
                .setFont(font)
                .setFontSize(10)
                .setTextAlignment(TextAlignment.CENTER)
                .setMarginTop(30));

        document.close();
    }

}
